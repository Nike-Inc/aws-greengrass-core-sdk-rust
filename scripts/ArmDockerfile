# syntax=docker/dockerfile:1.0.0-experimental
FROM artifactory.nike.com:9002/eap/rust-greengrass-base-arm:v4

ADD ./Cargo.toml ./Cargo.toml
ADD ./Cargo.lock ./Cargo.lock
ARG CARGO_VERSION
RUN mkdir src && \
    echo "fn main() {println!(\"gg_lambda_vendor_adapter: if you see this, the build broke ${CARGO_VERSION}\")}" > src/main.rs
ENV BINDGEN_EXTRA_CLANG_ARGS="--sysroot=/usr/arm-linux-gnueabihf -I/greengrass-arm/usr/local/include -L/greengrass-arm/usr/local/lib -I/usr/arm-linux-gnueabihf/include"
RUN cargo build --release

ADD ./.local/copytarget-arm.sh ./
ADD ./src ./src
RUN touch src/main.rs &&  cargo build --target=armv7-unknown-linux-gnueabihf --release 

VOLUME [ "/data" ]
ENTRYPOINT [ "./copytarget-arm.sh"]